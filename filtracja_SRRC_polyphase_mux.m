% > transmisja danych ukszta³towanych filtrem SRRC
% > odbiór danych przy u¿yciu jednego filtru z dekompozycji polifazowej
% filtra odbiorczego SRRC
% > sprawdzenie b³êdu synchronizacji

clear; close all; clc;

rolloff = 0.9;
symbols = 10; % szerokoœæ odpowiedzi impulsowych
N1 = 2; % probek na symbol w odp. impulsowej tranmitera
N2 = 32; % poziom nadpróbkowania odp. impulsowej transmitera -> odp. impulsowa odbiornika  
sps = N1*N2; % probek na symbol w odp. impulsowej odbiornika
DataL = 500; % iloœæ transmitowanych symboli;
snr = 15;


% rxSig = awgn(delayedSig, snr, 'measured');


data = randi([0 1],DataL,1);
data = data';
% data = [-1, 1, -1, ones(1,10)]';

B = rcosdesign(rolloff, symbols, sps, 'sqrt'); % odbiornik
A = rcosdesign(rolloff, symbols, N2*sps, 'sqrt'); % nadajnik
% B = B * sqrt(length(B));
% A = A(9:end); 
% return;


% TRANSMITER
% y_transmit = conv(A, data)'; % shaped data
y_transmit = upfirdn(data, A, N2*sps);
% y_transmit = conv(A, data); % shaped data
% y_transmit = y_transmit(floor(symbols*N1/2) + 1 : end);

% y_transmit = filter(A, 1, data);
p = 10;
y_transmit = [zeros(1, p) , y_transmit(1:end-p)];
% y_transmit = y_transmit(1:N2:end);

% y_transmit = [y_transmit; zeros(rem(length(y_transmit), 32), 1)];

x = (1:N1:N1*(length(data)));
figure(1);
stem(x, data, 'kx'); hold on;
plot(y_transmit, 'o-');

% RECEIVER
% dekompozycja polifazowa filtru (jego odp. impulsowej) uprzednio zinterpolowanego

% y_transmit = awgn(y_transmit, snr, 'measured');

rec_filtered = [];
% taps_per_filter = ceil(length(B) / N2);
taps_per_filter = ceil(length(B));
B = [B, zeros(1, N2*taps_per_filter)];
% B = 100000 * B;

for n=0:N2-1
   x = n : N2 : N2*taps_per_filter - 1;   
%    skladowa = conv(B(x+1), y_transmit');
   skladowa = conv(B(x+1), y_transmit);
   % przesuniecie o polowe dlugosci filtra
   skladowa = skladowa(floor(taps_per_filter/2) + 1: end); 
   rec_filtered = [rec_filtered; skladowa];
   figure(2);
   plot(rec_filtered(n+1, :), '.-'); grid on; hold on;
%    pause(0.2);   
end

diff_rec_filtered = [];
diff_rec_filtered_2 = [];
% difftaps = [0,-0.000333927433526001,-0.000337019096219881,-0.000338302967882216,-0.000337733817274593,-0.000335275066329612,-0.000330899157594726,-0.000324587885001951,-0.000316332685714848,-0.000306134890949180,-0.000294005933819920,-0.000279967512436080,-0.000264051706643090,-0.000246301047001470,-0.000226768534789140,-0.000205517612020930,-0.000182622080693560,-0.000158165970685850,-0.000132243355970830,-0.000104958119028660,-7.64236635855103e-05,-4.67625760426698e-05,-1.61062362009699e-05,1.54056218726502e-05,4.76253977475501e-05,8.03981599723099e-05,0.000113562227291550,0.000146949793935840,0.000180387596954510,0.000213697623337280,0.000246697854453560,0.000279203045129340,0.000311025534481490,0.000341976085438690,0.000371864749699560,0.000400501754710717,0.000427698409092759,0.000453268022801632,0.000477026838185686,0.000498794967987627,0.000518397336244937,0.000535664617962988,0.000550434173373322,0.000562550972544937,0.000571868506089556,0.000578249677693950,0.000581567674222460,0.000581706809161680,0.000578563335227490,0.000572046222021030,0.000562077894705780,0.000548594929782470,0.000531548704160750,0.000510905993867540,0.000486649518890900,0.000458778430833540,0.000427308740243070,0.000392273680694819,0.000353724006926900,0.000311728224566020,0.000266372749235090,0.000217761993098850,0.000166018377180881,0.000111282268073370,5.37118379585399e-05,-6.51715283324014e-06,-6.92116511899505e-05,-0.000134161684651139,-0.000201140812725550,-0.000269906655582840,-0.000340201499279810,-0.000411752976350530,-0.000484274820260090,-0.000557467691894080,-0.000631020075931300,-0.000704609244628150,-0.000777902286229950,-0.000850557194918960,-0.000922224018912750,-0.000992546063040660,-0.00106116114185151,-0.00112770287904511,-0.00119180204877266,-0.00125308795411952,-0.00131118983786922,-0.00136573832044954,-0.00141636685978284,-0.00146271322760362,-0.00150442099666713,-0.00154114103315493,-0.00157253298848776,-0.00159826678468245,-0.00161802408733895,-0.00163149976031705,-0.00163840329615882,-0.00163846021633368,-0.00163141343542811,-0.00161702458347140,-0.00159507528068150,-0.00156536835903320,-0.00152772902519180,-0.00148200595951920,-0.00142807234604800,-0.00136582682852750,-0.00129519438787870,-0.00121612713664530,-0.00112860502630270,-0.00103263646357890,-0.000928258832246499,-0.000815538917178400,-0.000694573227798402,-0.000565488218414501,-0.000428440403298799,-0.000283616364753599,-0.000131232652799601,2.84644244731985e-05,0.000195199120447402,0.000368666679550201,0.000548533876572499,0.000734439665032199,0.000925995933455600,0.00112278836802740,0.00132437741964230,0.00153029937297440,0.00174006751477130,0.00195317339818060,0.00216908819951930,0.00238726416351840,0.00260713613270600,0.00282812315623415,0.00304963017311660,0.00327104976452316,0.00349176396946960,0.00371114615795755,0.00392856295535723,0.00414337621158145,0.00435494500838189,0.00456262769790479,0.00476578396547293,0.00496377690941760,0.00515597513066845,0.00534175482471780,0.00552050186851650,0.00569161389482180,0.00585450234651580,0.00600859450343380,0.00615333547429380,0.00628819014640130,0.00641264508590930,0.00652621038155320,0.00662842142494211,0.00671884062068191,0.00679705901982420,0.00686269787037700,0.00691541007888410,0.00695488157737330,0.00698083259028801,0.00699301879635809,0.00699123238071779,0.00697530297296850,0.00694509846726271,0.00690052572091361,0.00684153112845459,0.00676810106850979,0.00668026222129810,0.00657808175504331,0.00646166738004481,0.00633116726962739,0.00618676984768010,0.00602870344296501,0.00585723581087899,0.00567267352381599,0.00547536123175500,0.00526568079520401,0.00504405029306601,0.00481092290845400,0.00456678569596698,0.00431215823432300,0.00404759116871301,0.00377366464763598,0.00349098665933500,0.00320019127338400,0.00290193679327599,0.00259690382621799,0.00228579327664902,0.00196932427025801,0.00164823201557798,0.00132326561042001,0.000995185800640008,0.000664762698928012,0.000332773471407005,0,-0.000332773471407005,-0.000664762698928012,-0.000995185800640008,-0.00132326561042001,-0.00164823201557798,-0.00196932427025801,-0.00228579327664902,-0.00259690382621799,-0.00290193679327599,-0.00320019127338400,-0.00349098665933500,-0.00377366464763598,-0.00404759116871301,-0.00431215823432300,-0.00456678569596698,-0.00481092290845400,-0.00504405029306601,-0.00526568079520401,-0.00547536123175500,-0.00567267352381599,-0.00585723581087899,-0.00602870344296501,-0.00618676984768010,-0.00633116726962739,-0.00646166738004481,-0.00657808175504331,-0.00668026222129810,-0.00676810106850979,-0.00684153112845459,-0.00690052572091361,-0.00694509846726271,-0.00697530297296850,-0.00699123238071779,-0.00699301879635809,-0.00698083259028801,-0.00695488157737330,-0.00691541007888410,-0.00686269787037700,-0.00679705901982420,-0.00671884062068191,-0.00662842142494211,-0.00652621038155320,-0.00641264508590930,-0.00628819014640130,-0.00615333547429380,-0.00600859450343380,-0.00585450234651580,-0.00569161389482180,-0.00552050186851650,-0.00534175482471780,-0.00515597513066845,-0.00496377690941760,-0.00476578396547293,-0.00456262769790479,-0.00435494500838189,-0.00414337621158145,-0.00392856295535723,-0.00371114615795755,-0.00349176396946960,-0.00327104976452316,-0.00304963017311660,-0.00282812315623415,-0.00260713613270600,-0.00238726416351840,-0.00216908819951930,-0.00195317339818060,-0.00174006751477130,-0.00153029937297440,-0.00132437741964230,-0.00112278836802740,-0.000925995933455600,-0.000734439665032199,-0.000548533876572499,-0.000368666679550201,-0.000195199120447402,-2.84644244731985e-05,0.000131232652799601,0.000283616364753599,0.000428440403298799,0.000565488218414501,0.000694573227798402,0.000815538917178400,0.000928258832246499,0.00103263646357890,0.00112860502630270,0.00121612713664530,0.00129519438787870,0.00136582682852750,0.00142807234604800,0.00148200595951920,0.00152772902519180,0.00156536835903320,0.00159507528068150,0.00161702458347140,0.00163141343542811,0.00163846021633368,0.00163840329615882,0.00163149976031705,0.00161802408733895,0.00159826678468245,0.00157253298848776,0.00154114103315493,0.00150442099666713,0.00146271322760362,0.00141636685978284,0.00136573832044954,0.00131118983786922,0.00125308795411952,0.00119180204877266,0.00112770287904511,0.00106116114185151,0.000992546063040660,0.000922224018912750,0.000850557194918960,0.000777902286229950,0.000704609244628150,0.000631020075931300,0.000557467691894080,0.000484274820260090,0.000411752976350530,0.000340201499279810,0.000269906655582840,0.000201140812725550,0.000134161684651139,6.92116511899505e-05,6.51715283324014e-06,-5.37118379585399e-05,-0.000111282268073370,-0.000166018377180881,-0.000217761993098850,-0.000266372749235090,-0.000311728224566020,-0.000353724006926900,-0.000392273680694819,-0.000427308740243070,-0.000458778430833540,-0.000486649518890900,-0.000510905993867540,-0.000531548704160750,-0.000548594929782470,-0.000562077894705780,-0.000572046222021030,-0.000578563335227490,-0.000581706809161680,-0.000581567674222460,-0.000578249677693950,-0.000571868506089556,-0.000562550972544937,-0.000550434173373322,-0.000535664617962988,-0.000518397336244937,-0.000498794967987627,-0.000477026838185686,-0.000453268022801632,-0.000427698409092759,-0.000400501754710717,-0.000371864749699560,-0.000341976085438690,-0.000311025534481490,-0.000279203045129340,-0.000246697854453560,-0.000213697623337280,-0.000180387596954510,-0.000146949793935840,-0.000113562227291550,-8.03981599723099e-05,-4.76253977475501e-05,-1.54056218726502e-05,1.61062362009699e-05,4.67625760426698e-05,7.64236635855103e-05,0.000104958119028660,0.000132243355970830,0.000158165970685850,0.000182622080693560,0.000205517612020930,0.000226768534789140,0.000246301047001470,0.000264051706643090,0.000279967512436080,0.000294005933819920,0.000306134890949180,0.000316332685714848,0.000324587885001951,0.000330899157594726,0.000335275066329612,0.000337733817274593,0.000338302967882216,0.000337019096219881,0.000333927433526001,0.000329081462473146,0,0];
%dodane zero na koncu wektora

difftaps = licz_diff(B);
difftaps = [zeros(1, 1), difftaps(1: end), zeros(1, 2)];
% difftaps = difftaps * 1000;
% taps_per_filter = ceil(length(difftaps) / N2);
% difftaps = [difftaps, zeros(1, N2*taps_per_filter)];

for n=0:N2-1
%    diff_B = diff(B);
   x = n : N2 : N2*taps_per_filter-1;
%    skladowa = conv(difftaps(x+1), y_transmit');
   skladowa = conv(difftaps(x+1), y_transmit);
%    skladowa = 1000*skladowa;
   % przesuniecie o polowe dlugosci filtra
   skladowa = skladowa(floor(taps_per_filter/2) + 1: end);
   diff_rec_filtered = [diff_rec_filtered; skladowa];
   
%    skladowa = filter(diff(B(x+1)), 1, y_transmit)';
%    skladowa = skladowa(sps*symbols/(2*N2) + 1 : end);
%    diff_rec_filtered_2 = [diff_rec_filtered_2; skladowa];
   figure(2);
   plot(diff_rec_filtered(n+1, :), '.-'); grid on; hold on;
%    pause(0.2);   
end


mult = rec_filtered .* diff_rec_filtered;
% mult_2 = rec_filtered .*  diff_rec_filtered_2;
figure(4);
plot(mult(1, :), 'b.'); hold on;

% sumowanie iloczynów i porównanie z zerem
sumy = [];
for n=1:N2
    skladowa = mult(n, 1:2);
    suma = sum(skladowa);
    sumy = [sumy, suma];
    disp("dla m=" + string(n-1) + ": " + string(suma));
end

index = find( abs(sumy) == min(abs(sumy)) );
disp("najblizej error=0 dla m=" + string(index-1));

% for p = 0 : N1-1
%    suma = sum(result( 1 + p*N1 : (p+1)*N1)),
% end
return;



